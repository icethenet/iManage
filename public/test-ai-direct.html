<!DOCTYPE html>
<html>
<head>
    <title>AI Tagging Debug</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; }
        button { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        #log { background: #2d2d2d; color: #0f0; padding: 15px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; margin: 20px 0; white-space: pre-wrap; }
        input { padding: 8px; width: 100%; margin: 10px 0; box-sizing: border-box; }
    </style>
</head>
<body>
    <h1>ðŸ”¬ AI Tagging Direct Test</h1>
    
    <div class="info">
        <strong>Test Your Actual Image URL:</strong>
        <input type="text" id="imageUrl" placeholder="Paste your image URL here (e.g., http://localhost/imanage/public/uploads/John/folder/original/image.jpg)">
        <button onclick="testUrl()">ðŸš€ TEST THIS IMAGE</button>
    </div>
    
    <div id="status"></div>
    <div id="log"></div>
    <img id="testImg" style="max-width: 100%; display: none; margin: 20px 0; border: 2px solid #ddd;">
    
    <script>
        const log = document.getElementById('log');
        const status = document.getElementById('status');
        let model = null;
        
        function addLog(msg, color = '#0f0') {
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `<span style="color:${color}">[${time}] ${msg}</span>\n`;
            log.scrollTop = log.scrollHeight;
        }
        
        function setStatus(msg, type = 'info') {
            status.innerHTML = `<div class="status ${type}">${msg}</div>`;
        }
        
        async function testUrl() {
            const url = document.getElementById('imageUrl').value.trim();
            if (!url) {
                alert('Please paste an image URL first!');
                return;
            }
            
            log.innerHTML = '';
            addLog('=== STARTING TEST ===', '#00f');
            addLog('Image URL: ' + url);
            
            try {
                // Step 1: Load model
                setStatus('â³ Loading AI model...', 'info');
                addLog('\nðŸ“¦ Step 1: Loading MobileNet...');
                if (!model) {
                    model = await mobilenet.load();
                    addLog('âœ… Model loaded', '#0f0');
                } else {
                    addLog('âœ… Using cached model', '#0f0');
                }
                
                // Step 2: Extract path for proxy
                setStatus('ðŸ”„ Preparing image...', 'info');
                addLog('\nðŸ“‚ Step 2: Parsing URL...');
                const uploadsPattern = /\/uploads\/(.+)/;
                const match = url.match(uploadsPattern);
                
                if (!match) {
                    throw new Error('URL does not contain /uploads/ path');
                }
                
                const path = match[1];
                addLog('Extracted path: ' + path);
                
                // Step 3: Build proxy URL
                const proxyUrl = 'image-proxy.php?path=' + path;
                addLog('Proxy URL: ' + proxyUrl);
                
                // Step 4: Test proxy access
                setStatus('ðŸ” Testing proxy access...', 'info');
                addLog('\nðŸ” Step 3: Testing image-proxy.php...');
                const proxyTest = await fetch(proxyUrl);
                addLog('Proxy status: ' + proxyTest.status + ' ' + proxyTest.statusText);
                
                if (!proxyTest.ok) {
                    const errorText = await proxyTest.text();
                    addLog('âŒ PROXY ERROR: ' + errorText, '#f00');
                    throw new Error('Proxy returned ' + proxyTest.status + ': ' + errorText);
                }
                addLog('âœ… Proxy accessible', '#0f0');
                
                // Step 5: Load image
                setStatus('ðŸ–¼ï¸ Loading image...', 'info');
                addLog('\nðŸ–¼ï¸ Step 4: Loading image through proxy...');
                const img = await loadImage(proxyUrl);
                addLog('âœ… Image loaded: ' + img.width + 'x' + img.height, '#0f0');
                
                document.getElementById('testImg').src = proxyUrl;
                document.getElementById('testImg').style.display = 'block';
                
                // Step 6: Classify
                setStatus('ðŸ¤– Running AI classification...', 'info');
                addLog('\nðŸ¤– Step 5: Classifying with MobileNet...');
                const predictions = await model.classify(img);
                addLog('âœ… Classification complete!', '#0f0');
                addLog('Predictions received: ' + predictions.length);
                
                // Step 7: Extract tags
                addLog('\nðŸ·ï¸ Step 6: Extracting tags...');
                const tags = predictions
                    .filter(p => p.probability > 0.05)
                    .slice(0, 5)
                    .map(p => p.className.split(',')[0].trim().toLowerCase().replace(/_/g, ' '));
                
                addLog('âœ… TAGS: ' + tags.join(', '), '#0f0');
                
                predictions.forEach((p, i) => {
                    addLog(`  ${i+1}. ${p.className} (${(p.probability*100).toFixed(2)}%)`, '#ff0');
                });
                
                setStatus('âœ… SUCCESS! Tags: ' + tags.join(', '), 'success');
                
            } catch (error) {
                addLog('\nâŒ ERROR: ' + error.message, '#f00');
                addLog('Stack: ' + error.stack, '#f00');
                setStatus('âŒ FAILED: ' + error.message, 'error');
            }
        }
        
        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                // Don't use crossOrigin for same-origin - it blocks cookies!
                addLog('Loading image without crossOrigin to send session cookies', '#ff0');
                
                const timeout = setTimeout(() => {
                    reject(new Error('Image load timeout after 10 seconds'));
                }, 10000);
                
                img.onload = () => {
                    clearTimeout(timeout);
                    resolve(img);
                };
                
                img.onerror = (e) => {
                    clearTimeout(timeout);
                    reject(new Error('Failed to load image. Check browser console for details.'));
                };
                
                img.src = src;
            });
        }
        
        // Auto-fill from current page if available
        window.addEventListener('load', () => {
            addLog('Ready! Paste your image URL above and click TEST.', '#ff0');
            addLog('Example: http://localhost/imanage/public/uploads/John/Asian%20Girls/original/image.webp', '#888');
        });
    </script>
</body>
</html>

